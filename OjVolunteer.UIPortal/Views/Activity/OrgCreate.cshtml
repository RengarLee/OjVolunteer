@model OjVolunteer.Model.Activity

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>瓯江义工网</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/oj/css/admin.css" rel="stylesheet" />
    <style type="text/css">
        #l-map {
            height: 300px;
            width: 300px;
            display: none;
        }

        img {
            height: 300px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="layui-layout layui-layout-admin">
        <form id="form1" class="layui-form layui-form-pane acStart">
            <h2 class="acStart-title">发布活动</h2>
            <hr />
            <div class="acStart-box">
                <div class="layui-form-item">
                    <label class="layui-form-label">活动名称</label>
                    <div class="layui-input-block">
                        @Html.EditorFor(model => model.ActivityName, new { htmlAttributes = new { @class = "layui-input", lay_verify = "required|actionName" } })
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline acStart-left">
                        <label class="layui-form-label ">负责人ID</label>
                        <div class="layui-input-block">
                            @Html.EditorFor(model => model.ActivityManagerID, new { htmlAttributes = new { @class = "layui-input", lay_verify = "required" } })
                        </div>
                    </div>
                    <div class="layui-inline acStart-left">
                        <button type="button" id="btnSer" name="btnSer" value="查找" class="layui-btn">查找</button>
                    </div>
                    <div class="layui-inline">
                        <div id="manager" class="acStart-jieGuo"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label ">活动类型</label>
                    <div class="layui-input-block">
                        @Html.DropDownList("ActivityTypeID", null, new { htmlAttributes = new { @lay_verify = "required" } })
                    </div>
                </div>
                <div class="layui-form-item">
                    <div id="l-map"></div>
                    <div class="layui-inline acStart-mapleft">
                        <label class="layui-form-label acStart-map" id="r-result">活动地点</label>
                        <div class="layui-input-block">
                            @Html.EditorFor(model => model.ActivityAddress, new { htmlAttributes = new { @class = "layui-input", lay_verify = "required|", id = "suggestId", size = "20" } })
                            @Html.HiddenFor(model => model.ActivityAddressX)
                            @Html.HiddenFor(model => model.ActivityAddressY)
                        </div>
                    </div>
                    <div class="layui-inline acStart-left">
                        <div id="address" style="overflow:hidden;width:190px;white-space:nowrap;text-overflow:ellipsis;height:38px;line-height:38px;"></div>
                        <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">报名时间</label>
                    <div class="layui-input-block">
                        <input type="text" name="EnrollTime" required placeholder="请输入报名时间范围" class="layui-input" id="timeEnrollRange">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">活动时间</label>
                    <div class="layui-input-block">
                        <input type="text" name="ActivityTime" required placeholder="请输入活动时间范围" class="layui-input" id="timeRange">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline acStart-short">
                        <label class="layui-form-label ">人数上限</label>
                        <div class="layui-input-block">
                            @Html.EditorFor(model => model.ActivityPrediNum, new { htmlAttributes = new { @class = "layui-input", lay_verify = "required|joinNumber|MaxNumber" } })
                        </div>
                    </div>
                    <div class="layui-inline acStart-short">
                        <div class="layui-input-block">
                            @Html.HiddenFor(model => model.ActivityIcon)
                            <button type="button" class="layui-btn" id="test1">点击上传活动封面</button>
                        </div>
                    </div>
                </div>
                <!--富文本框-->
                <h4 class="acArticle">活动详情</h4>
                @*<textarea id="demo" name="ActivityContent" style="display: none;"></textarea>*@
                @Html.TextAreaFor(Model => Model.ActivityContent, new { style = "display: none;", id = "demo" })
                <div class="acStart-Condition">
                    <div class="layui-collapse">
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">可参加活动的政治面貌</h2>
                            <div class="layui-colla-content">
                                @Html.HiddenFor(model => model.ActivityPolitical)
                                @{ Dictionary<int, String> PoliticalDict = (Dictionary<int, String>)ViewBag.PoliticalDict;}
                                @foreach (var key in PoliticalDict.Keys)
                                {
                                    <input type="checkbox" value="@key" typename="PoliticalDict" id="@key" title="@PoliticalDict[key]" checked />
                                }
                            </div>
                        </div>
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">可参加活动的学院</h2>
                            <div class="layui-colla-content">
                                @Html.HiddenFor(model => model.ActivityMajor)
                                @{ Dictionary<int, String> MajorDict = (Dictionary<int, String>)ViewBag.MajorDict;}
                                @foreach (var key in MajorDict.Keys)
                                {
                                    <input type="checkbox" value="@key" typename="MajorDict" id="@key" title="@MajorDict[key]" checked />
                                }
                            </div>
                        </div>
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">可参加活动的专业</h2>
                            <div class="layui-colla-content">
                                @Html.HiddenFor(model => model.ActivityDepartment)
                                @{ Dictionary<int, String> DepartmentDict = (Dictionary<int, String>)ViewBag.DepartmentDict;}
                                @foreach (var key in DepartmentDict.Keys)
                                {
                                    <input type="checkbox" value="@key" typename="DepartmentDict" id="@key" title="@DepartmentDict[key]" checked />
                                }
                            </div>
                        </div>
                    </div>
                </div>


                <div class="acArticle-btn">
                    <div class="layui-form-item">
                        <button class="layui-btn" id="btnSubmit" type="button" lay-submit>发布</button>
                        <button type="reset" class="layui-btn layui-btn-primary" id="testbtn">取消发布</button>
                    </div>
                </div>
            </div>
        </form>
        <div id="l-map"></div>

    </div>

    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=HisYFGGE2IDgsNH7xUAEQfExLIxpWwDh"></script>
    <script src="~/Content/oj/js/jquery-1.12.4.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script src="~/Scripts/App/simple-ajax-form.js"></script>
    <script src="~/Content/oj/js/admin.js"></script>
    <script src="~/Content/oj/js/check.js"></script>
    <script type="text/javascript">
            BindSubmit();
            BindSearchKey();
            layui.use('upload', function () {
                var upload = layui.upload;
                var uploadInst = upload.render({
                    elem: '#test1'
                    , url: '/Activity/UploadIcon'
                    , accept: 'images'
                    , size: 2048
                    , done: function (res) {
                        if (res["msg"] == "fail") {
                            alert("上传失败，请稍后再试");
                        } else {
                            $("#ActivityIcon").attr("value", res["src"]);
                            alert("上传成功");
                        }
                    }
                    , error: function () {
                        alert("上传失败，请稍后再试")
                    }
                });
        });

            //日期组件
            var huodong;
            var baoming;
            layui.use('laydate', function () {
                var laydate = layui.laydate;
                laydate.render({
                    elem: '#timeRange',
                    type: 'datetime',
                    range: true
                    , done: function (value, date, endDate) {
                        huodong = date;
                        console.log(huodong);
                    }
                });

                var laydate1 = layui.laydate;
                laydate.render({
                    elem: '#timeEnrollRange',
                    type: 'datetime',
                    range: true
                    , ready: function () {
                        layer.tips('报名结束时间应比活动开始时间早！', '#timeEnrollRange', {
                            tips: [1] //还可配置颜色
                        });
                    }
                    , done: function (value, date, endDate) {
                        baoming = endDate;
                        console.log(baoming);
                    }
                });
            });

        function checktime() {
            if (baoming.year > huodong.year) {
                alert("活动时间早于报名时间");
            }
            else {
                if (baoming.month > huodong.month) {
                    alert("活动时间早于报名时间");
                }
                else {
                    if (baoming.date > huodong.date) {
                        alert("活动时间早于报名时间");
                    }
                    else {
                        if (baoming.hours > huodong.date) {
                            alert("活动时间早于报名时间");
                        }
                        else {
                            if (baoming.minutes > huodong.minutes) {
                                alert("活动时间早于报名时间");
                            }
                            else {
                                if (baoming.seconds > huodong.seconds) {
                                    alert("活动时间早于报名时间");
                                }
                                else {
                                    alert("验证通过！");
                                }
                            }
                        }
                    }
                }
            }
        }
        
        //查找负责人
        function BindSearchKey() {
            $('#btnSer').click(function () {
                $.post("/UserInfo/SearchActivityPeople", { key: $("#ActivityManagerID").val() }, function (data) {
                    if (data["msg"] == "success") {
                        var buffer = "登录名：" + data["login"] + " " + "真实姓名：" + data["showname"];

                    } else {
                        var buffer = "查无此人";
                    }
                    $("#manager").html(buffer);
                });
            });
        }
        function BindSubmit() {

            $("#btnSubmit").click(function () {
                beforeSubmit();
                layedit.sync(index);
                checktime()
                $.post("/Activity/Create", $("#form1").serializeArray(), function (data) {
                    if (data["msg"] == "success") {
                        alert("申请成功，请等待审核！");
                    } else {
                        alert("出现错误,请稍后再试！");
                    }
                });
            });
        }

        //数据绑定
        function beforeSubmit() {
            var Politicalresult = ",";
            $("input[typename='PoliticalDict']:not(:checked)").each(function () {
                Politicalresult += $(this).val() + ',';
            });
            $("#ActivityPolitical").val(Politicalresult);

            var Majorresult = ",";
            $("input[typename='MajorDict']:not(:checked)").each(function () {
                Majorresult += $(this).val() + ',';
            });
            $("#ActivityMajor").val(Majorresult);

            var Departmentresult = ",";
            $("input[typename='DepartmentDict']:not(:checked)").each(function () {
                Departmentresult += $(this).val() + ',';
            });
            $("#ActivityDepartment").val(Departmentresult);
        }

       
        //富文本框
        var index;
        var layedit;
        layui.use('layedit', function () {
            layedit = layui.layedit;
            layedit.set({
                uploadImage: {
                    url: '/Activity/UploadContentImage',
                    type: 'post'
                }
            });
            index = layedit.build('demo', {
                tool: [
                    'strong' //加粗
                    , 'italic' //斜体
                    , 'underline' //下划线
                    , 'del' //删除线
                    , '|' //分割线
                    , 'left' //左对齐
                    , 'center' //居中对齐
                    , 'right' //右对齐
                    , 'image' //插入图片
                ]
            }); //建立编辑器

        })
        //折叠面板
        layui.use('element', function () {
            var element = layui.element;

        });


        // 百度地图API功能
        function G(id) {
            return document.getElementById(id);
        }
        var map = new BMap.Map("l-map");
        map.centerAndZoom("温州", 12);

        var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
            {
                "input": "suggestId"
                , "location": map
            });
        ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
            var str = "";
            var _value = e.fromitem.value;
            var value = "";
            if (e.fromitem.index > -1) {
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

            value = "";
            if (e.toitem.index > -1) {
                _value = e.toitem.value;
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
            G("searchResultPanel").innerHTML = str;
        });

        var myValue;
        ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
            G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

            setPlace(myValue);
        });
        function setPlace(myValue) {
            map.clearOverlays();    //清除地图上所有覆盖物
            function myFun() {
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                //
                var poi = local.getResults().getPoi(0);


                var path = "<a  target='_blank' href='https://map.baidu.com/mobile/webapp/search/search/qt=s&amp;wd=" + myValue + "/vt=map'>点击查看位置详情</a>";
                $("#address").html(path);
                var lng = String(pp.lng);
                var lat = String(pp.lat);
                $("#ActivityAddressX").val(lng.substring(0, lng.indexOf(".") + 3));
                $("#ActivityAddressY").val(lat.substring(0, lng.indexOf(".") + 3));

                map.centerAndZoom(pp, 18);
                map.addOverlay(new BMap.Marker(pp));    //添加标注
            }
            var local = new BMap.LocalSearch(map, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(myValue);
        }

    </script>
</body>
</html>