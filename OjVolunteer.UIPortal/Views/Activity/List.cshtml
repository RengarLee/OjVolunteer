@{
    Layout = "~/Views/Shared/User_Layout.cshtml";
}
<div class="action-bg">
    <header>
        <nav class="top">
            <p>活动列表</p>
        </nav>
    </header>
    <nav class="classnav">
        <form class="layui-form" " action="">
            <div class="layui-form-item">
                @Html.DropDownList("ActivityTypeID", null, "全部活动", new { lay_filter="aihao", onchange="selectchange()"})
            </div>
        </form>

    </nav>

    <div class="acbox">
        <ul id="actul" class="ac-list">
            <li class="aclist-box">
                <div class="clearfix">
                    <a href="acmore.html" class="aclist-box-img">
                        <img src="images/acimg.png">
                    </a>
                    <div class="aclist-box-info">
                        <a href="acmore.html">1月13日（星期六下午）在温大北校区7号楼打扫703教室</a>
                        <span class="actime">
                            时间: 01.13 12:00-15:00
                        </span>
                        <br>
                        <span class="acendtime">
                            截止: 2018.04.06 18:00
                        </span>
                        <br /><br />
                        <p>招募人数：<span>20</span>人</p>
                        <p>已报名：<span>5</span>人</p>
                        <div class="acbox-btn">
                            <button class="btn">我要报名</button>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</div>

@section Script{
    <script type="text/javascript">
        layui.use('form', function () {
            var form = layui.form;
            
            form.on('select(aihao)', function (data) {
                $("li").remove();
                var typeId = $("select option:selected").val();
                GetActivityData(1, 5, typeId);
            });     
        });

        $(function () {
            GetActivityData(1, 5);
        });

        //加载活动数据
        function GetActivityData(pageIndex, pageSize, typeId) {
            $.post("/Activity/GetListData", { pageIndex: pageIndex, pageSize: pageSize, typeId: typeId }, function (data) {
                $("#btnevent").remove();
                if (data["msg"] == "success") {
                    for (var i in data["data"]) {
                        var temp = data["data"][i];
                        //图片
                        var li = $("<li class='aclist-box clearfix'></li>");
                        var li_a = $("<a class='aclist-box-img' href='/Activity/Details/?Id=" + temp.ActivityID + "'></a>");
                        var li_a_img = $("<img/>");
                        li_a_img.attr("src", temp.ActivityIcon);
                        li_a.append(li_a_img);
                            
                        var li_div = $("<div class='aclist-box-info'></div>");
                        var li_div_a = $("<a href='/Activity/Details/?Id=" + temp.ActivityID + "'></a>");
                        li_div_a.text(temp.ActivityName);
                        var li_div_s1 = $("<span class='actime'></span>"); 
                        li_div_s1.text("预计活动时间" + TimeFormat(temp.ActivityStart, "yyyy-MM-dd HH:mm") + "-" + TimeFormat(temp.ActivityEnd, "HH:mm"));
                        var li_div_s2 = $("<span class='acendtime'></span>");
                        li_div_s2.text("报名截止时间" + TimeFormat(temp.ActivityEnrollEnd, "yyyy-MM-dd HH:mm"));
                        var li_div_s3 = $("<span class='acendtime'></span>");
                        li_div_s3.text("招募:" + temp.ActivityPrediNum + "人   已报名:" + temp.Count +"人");
                        li_div.append(li_div_a);
                        li_div.append(li_div_s1);
                        li_div.append("<br>");
                        li_div.append(li_div_s2);
                        li_div.append("<br>");
                        li_div.append(li_div_s3);

                        var li_bdiv = $("<div class='acbox-btn'></div>");
                        li_bdiv.append("<button class='btn btnEnroll' activity='"+temp.ActivityID+"'>我要报名</button>");
                            

                        li.append(li_a);
                        li.append(li_div);
                        li.append(li_bdiv);
                        $("#actul").append(li);
                    }
                    var btn_li = $("<li style='text-align:center;'></li>");
                    var btn_input = $("<input type='button' id='btnevent' value='查看更多' style='border:none;background:#eee;'/>");
                    pageIndex++;
                    btn_input.attr("pageIndex", pageIndex);
                    btn_li.append(btn_input);
                    $("#actul").append(btn_li);
                    BindEnrollClickEvent();
                    BindActivtyListClickEvent();
                } else {
                    var btn_li = $("<li></li>");
                    btn_li.text("无新内容");
                    $("#actul").append(btn_li);
                    
                }
            });

        }

        //查看更多活动按钮绑定
        function BindActivtyListClickEvent() {
            $("#btnevent").click(function () {
                var pageIndex = parseInt($("#btnevent").attr("pageIndex"));
                var pageSize = 5;
                var typeId = $("#ActivityTypeID").val();
                GetActivityData(pageIndex, pageSize, typeId);
            });
        }

        //报名按钮绑定事件
        function BindEnrollClickEvent() {
            $(".btnEnroll").click(function () {
                var activityId = $(this).attr("activity");
                $.post("/UserEnroll/Create/", { activityId: activityId }, function (data) {
                    if (data["msg"] == "exists") {
                        layer.msg("您已报名");
                    } else if (data["msg"] == "audit") {
                        layer.msg("您的政治面貌尚未审核，无法报名活动，请耐心等待审核！")
                    } else if (data["msg"] == "full") {
                        layer.msg("报名人数已满!");
                    } else if (data["msg"] == "fail") {
                        layer.msg("报名失败,请稍后再试!");
                    } else if (data["msg"] == "later") {
                        layer.msg("报名已结束!");
                    } else if (data["msg"] == "success") {
                        layer.msg("报名成功!");
                        //操作位置

                    }
                });
            });
        }

        //时间戳转为时间
        function TimeFormat(value,str) {
            return new Date(parseInt(value.replace("/Date(", "").replace(")/", ""), 10)).pattern(str);
        }
    </script>
}

@section Act_i{
    this-icon
}
@section Act_s{
    this-icon
}